<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-menu-button auto-hide="false"></ion-menu-button>
    </ion-buttons>
    <ion-title>Mon Entreprise</ion-title>
  </ion-toolbar>
  
  <ion-toolbar color="primary">
    <ion-segment [(ngModel)]="segment" value="docs" color="light">
      <ion-segment-button value="docs">
        <ion-label>GED <ion-icon *ngIf="hasExpiredDocs" name="warning" color="warning"></ion-icon></ion-label>
      </ion-segment-button>
      <ion-segment-button value="infos">
        <ion-label>Infos</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content class="bg-light ion-padding">

  <div *ngIf="segment === 'docs'">
    
    <div class="alert-banner" *ngIf="hasExpiredDocs">
      <ion-icon name="warning"></ion-icon>
      <span>Certains documents sont p√©rim√©s !</span>
    </div>

    <div class="ion-padding-bottom">
      <ion-button expand="block" color="tertiary" [routerLink]="['/duerp-form']" style="margin-bottom: 15px;">
        <ion-icon name="list" slot="start"></ion-icon>
        G√©rer le DUERP (Digital)
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </ion-button>
    </div>

    <ion-list class="doc-list">
      <ion-item-sliding *ngFor="let doc of docs">
        <ion-item lines="none" class="doc-item">
          <div slot="start" class="doc-icon" [ngClass]="doc.type_doc">
            <ion-icon [name]="getIcon(doc.type_doc)"></ion-icon>
          </div>
          <ion-label>
            <h2>{{ doc.titre }}</h2>
            <p><ion-badge color="light">{{ doc.type_doc }}</ion-badge></p>
            <div *ngIf="doc.date_expiration" class="exp-badge">
              <ion-badge [color]="getExpirationStatus(doc.date_expiration).color">
                {{ getExpirationStatus(doc.date_expiration).text }}
              </ion-badge>
            </div>
          </ion-label>
          <div slot="end">
            <ion-button fill="clear" color="dark" (click)="signDocument(doc)">
              <ion-icon name="pencil" slot="icon-only"></ion-icon>
            </ion-button>
            <ion-button fill="clear" color="primary" (click)="openDoc(doc.url)">
              <ion-icon name="eye" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </ion-item>
        <ion-item-options side="end">
          <ion-item-option color="danger" (click)="deleteDoc(doc)">
            <ion-icon name="trash" slot="icon-only"></ion-icon>
          </ion-item-option>
        </ion-item-options>
      </ion-item-sliding>
    </ion-list>

    <div *ngIf="docs.length === 0 && !isLoading" class="empty-state">
      <ion-icon name="folder-open" color="medium"></ion-icon>
      <p>Aucun document pour le moment.</p>
    </div>

    <ion-fab vertical="bottom" horizontal="end" slot="fixed">
      <ion-fab-button (click)="isUploadModalOpen = true">
        <ion-icon name="add"></ion-icon>
      </ion-fab-button>
    </ion-fab>
  </div>

  <div *ngIf="segment === 'infos' && company">
    <ion-card class="info-card">
      <ion-card-content>
        
        <div class="logo-container">
          <div class="logo-drop-zone" 
               [class.dragging]="isLogoDragging"
               (click)="triggerLogoUpload()"
               (dragover)="onLogoDragOver($event)"
               (dragleave)="onLogoDragLeave($event)"
               (drop)="onLogoDrop($event)">
            
            <img *ngIf="company.logo_url" 
              [src]="company.logo_url!.startsWith('data') ? company.logo_url : api.apiUrl + '/' + company.logo_url" 
              class="logo-preview" />
            
            <div *ngIf="!company.logo_url" class="placeholder-logo">
               <ion-icon name="image" style="font-size: 40px; color: #ccc;"></ion-icon>
            </div>

            <div class="drop-content">
              <ion-icon name="cloud-upload-outline"></ion-icon>
              <h3>Logo Entreprise</h3>
              <p>Glissez votre logo ici<br>ou cliquez pour choisir</p>
            </div>
          </div>
        </div>
        <input #logoInput type="file" (change)="onLogoSelected($event)" hidden accept="image/*">
        
        <ion-list lines="full">
          <ion-item>
            <ion-input label="Nom Soci√©t√©" labelPlacement="stacked" [(ngModel)]="company.name"></ion-input>
          </ion-item>
          <ion-item>
            <ion-input label="Adresse" labelPlacement="stacked" [(ngModel)]="company.address"></ion-input>
          </ion-item>
          <ion-item>
            <ion-input label="Email Contact" labelPlacement="stacked" [(ngModel)]="company.contact_email"></ion-input>
          </ion-item>
          <ion-item>
            <ion-input label="T√©l√©phone" labelPlacement="stacked" [(ngModel)]="company.phone"></ion-input>
          </ion-item>
        </ion-list>
        
        <ion-button expand="block" class="ion-margin-top" (click)="saveInfos()">Enregistrer les modifications</ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <ion-modal [isOpen]="isUploadModalOpen" (didDismiss)="closeUploadModal()" [initialBreakpoint]="0.75" [breakpoints]="[0, 0.75]">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Nouveau Document</ion-title>
          <ion-buttons slot="end"><ion-button (click)="closeUploadModal()">Fermer</ion-button></ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <ion-item fill="outline" class="mb-15">
          <ion-label position="floating">Titre du document</ion-label>
          <ion-input [(ngModel)]="newDoc.titre"></ion-input>
        </ion-item>
        
        <ion-item fill="outline" class="mb-15">
          <ion-label>Type de document</ion-label>
          <ion-select [(ngModel)]="newDoc.type_doc" interface="popover">
            <ion-select-option value="DUERP">üõ°Ô∏è DUERP (Scan PDF)</ion-select-option>
            <ion-select-option value="ASSURANCE">üìÑ Assurance D√©cennale</ion-select-option>
            <ion-select-option value="KBIS">üè¢ Kbis</ion-select-option>
            <ion-select-option value="AUTRE">üìÇ Autre</ion-select-option>
          </ion-select>
        </ion-item>
        
        <ion-item fill="outline" class="mb-15">
          <ion-label>Date d'Expiration</ion-label>
          <ion-datetime-button datetime="datetime"></ion-datetime-button>
          <ion-modal [keepContentsMounted]="true">
            <ng-template>
              <ion-datetime id="datetime" presentation="date" [(ngModel)]="newDoc.date_expiration"></ion-datetime>
            </ng-template>
          </ion-modal>
        </ion-item>

        <div class="file-box" (click)="fileInput.click()" [class.has-file]="selectedFile">
          <input #fileInput type="file" (change)="onFileSelected($event)" hidden accept=".pdf,.jpg,.png">
          <ion-icon [name]="selectedFile ? 'document-text' : 'cloud-upload'" size="large"></ion-icon>
          <p>{{ selectedFile ? selectedFile.name : 'Choisir un fichier (PDF, JPG)' }}</p>
        </div>

        <ion-button expand="block" class="ion-margin-top" (click)="uploadDoc()" [disabled]="!selectedFile || !newDoc.titre">
          Uploader le document
        </ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>