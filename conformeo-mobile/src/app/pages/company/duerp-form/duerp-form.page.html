<ion-header>
  <ion-toolbar color="tertiary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/company"></ion-back-button>
    </ion-buttons>
    <ion-title>Édition DUERP {{ annee }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="downloadPdf()">
        <ion-icon name="download-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding bg-light">

  <div class="info-banner">
    <ion-icon name="information-circle"></ion-icon>
    <p>Remplissez les mesures : l'état se met à jour automatiquement.</p>
  </div>

  <div *ngFor="let l of lignes; let i = index" class="risk-card">
    
    <div class="risk-header" style="display: flex; align-items: center; gap: 10px;">
      
      <ion-item class="unit-input" lines="none" style="flex: 1; --background: transparent; --min-height: 30px;">
        <ion-icon name="business-outline" slot="start" size="small" style="margin-right: 8px; color: #666;"></ion-icon>
        <ion-input [(ngModel)]="l.unite_travail" placeholder="Unité (ex: Atelier)" style="font-weight: bold; color: var(--ion-color-primary);"></ion-input>
      </ion-item>

      <ion-chip [color]="l.statut === 'FAIT' ? 'success' : 'danger'" style="height: 24px; font-size: 12px;">
        <ion-icon [name]="l.statut === 'FAIT' ? 'checkmark-circle' : 'alert-circle'"></ion-icon>
        <ion-label>{{ l.statut }}</ion-label>
      </ion-chip>

      <ion-button fill="clear" color="danger" size="small" (click)="removeLine(i)">
        <ion-icon name="trash-outline"></ion-icon>
      </ion-button>
    </div>

    <ion-grid>
      <ion-row>
        <ion-col size="12">
          <ion-item class="input-item">
            <ion-label position="stacked">Tâche / Situation</ion-label>
            <ion-input [(ngModel)]="l.tache"></ion-input>
          </ion-item>
        </ion-col>
        
        <ion-col size="8">
          <ion-item class="input-item">
            <ion-label position="stacked">Risque</ion-label>
            <ion-input [(ngModel)]="l.risque"></ion-input>
          </ion-item>
        </ion-col>
        
        <ion-col size="4">
          <ion-item class="input-item">
            <ion-label position="stacked">Gravité</ion-label>
            <ion-select [(ngModel)]="l.gravite" interface="popover">
              <ion-select-option [value]="1">1 - Faible</ion-select-option>
              <ion-select-option [value]="2">2 - Moyen</ion-select-option>
              <ion-select-option [value]="3">3 - Grave</ion-select-option>
              <ion-select-option [value]="4">4 - Mortel</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col size="12">
          <ion-item class="input-item">
            <ion-label position="stacked">⚠️ Mesures À PRENDRE</ion-label>
            <ion-textarea [(ngModel)]="l.mesures_a_realiser" (ionInput)="autoUpdateStatus(l)" rows="2" placeholder="Si rempli = À FAIRE"></ion-textarea>
          </ion-item>
        </ion-col>

        <ion-col size="12">
          <ion-item class="input-item">
            <ion-label position="stacked">✅ Action TERMINÉE</ion-label>
            <ion-textarea [(ngModel)]="l.mesures_realisees" (ionInput)="autoUpdateStatus(l)" rows="2" placeholder="Si 'À faire' est vide et ceci rempli = FAIT"></ion-textarea>
          </ion-item>
        </ion-col>

        </ion-row>
    </ion-grid>
  </div>

  <ion-card class="add-card">
    <ion-card-header>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <ion-card-subtitle>Nouvelle Ligne</ion-card-subtitle>
        <ion-badge [color]="newLine.statut === 'FAIT' ? 'success' : 'danger'">
          {{ newLine.statut }}
        </ion-badge>
      </div>
    </ion-card-header>
    
    <ion-card-content>
      <ion-item fill="outline" class="mb-2">
        <ion-label position="floating">Unité de Travail</ion-label>
        <ion-input [(ngModel)]="newLine.unite_travail"></ion-input>
      </ion-item>

      <ion-item fill="outline" class="mb-2">
        <ion-label position="floating">Tâche</ion-label>
        <ion-input [(ngModel)]="newLine.tache"></ion-input>
      </ion-item>

      <ion-grid class="ion-no-padding">
        <ion-row>
          <ion-col size="8">
            <ion-item fill="outline" style="margin-right: 5px;">
              <ion-label position="floating">Risque</ion-label>
              <ion-input [(ngModel)]="newLine.risque"></ion-input>
            </ion-item>
          </ion-col>
          
          <ion-col size="4">
            <ion-item fill="outline">
              <ion-label position="floating">Gravité</ion-label>
              <ion-select [(ngModel)]="newLine.gravite">
                <ion-select-option [value]="1">1</ion-select-option>
                <ion-select-option [value]="2">2</ion-select-option>
                <ion-select-option [value]="3">3</ion-select-option>
                <ion-select-option [value]="4">4</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>

      <ion-item fill="outline" class="mt-2">
         <ion-label position="floating">Mesures À PRENDRE</ion-label>
         <ion-textarea [(ngModel)]="newLine.mesures_a_realiser" (ionInput)="autoUpdateStatus(newLine)"></ion-textarea>
      </ion-item>

      <ion-item fill="outline" class="mt-2">
         <ion-label position="floating">Action TERMINÉE</ion-label>
         <ion-textarea [(ngModel)]="newLine.mesures_realisees" (ionInput)="autoUpdateStatus(newLine)"></ion-textarea>
      </ion-item>

      <ion-button expand="block" (click)="addLine()" class="ion-margin-top" [disabled]="!newLine.tache || !newLine.risque">
        <ion-icon name="add-circle" slot="start"></ion-icon>
        Ajouter au DUERP
      </ion-button>
    </ion-card-content>
  </ion-card>

  <div class="spacer"></div>

</ion-content>

<ion-footer>
  <ion-toolbar>
    <ion-button expand="block" (click)="save()" color="success" size="large">
      <ion-icon name="save-outline" slot="start"></ion-icon>
      ENREGISTRER LE DUERP
    </ion-button>
  </ion-toolbar>
</ion-footer>