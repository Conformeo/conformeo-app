<ion-header class="ion-no-border">
  <ion-toolbar style="--background: #1e3c72; --color: white;">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home" text="" color="light"></ion-back-button>
    </ion-buttons>
    <ion-title *ngIf="!searchTerm">Matériel</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="inventory-content">

  <div class="mobile-only">

    <div class="header-section">
      <div class="header-top">
        <h1 class="page-title">Inventaire</h1>
        <p class="page-subtitle">Gérez vos équipements</p>
      </div>

      <div class="stats-row">
        <div class="stat-item">
          <span class="stat-num">{{ materiels.length }}</span>
          <span class="stat-label">Total</span>
        </div>
        <div class="stat-item warning">
          <span class="stat-num">{{ getMaterielsSortis() }}</span>
          <span class="stat-label">Sortis</span>
        </div>
        <div class="stat-item success">
          <span class="stat-num">{{ getMaterielsDepot() }}</span>
          <span class="stat-label">Dépôt</span>
        </div>
      </div>
    </div>

    <div class="search-container">
      <div class="search-wrapper">
        <ion-icon name="search-outline" class="search-icon"></ion-icon>
        <input 
          type="text" 
          placeholder="Rechercher..." 
          [(ngModel)]="searchTerm" 
          (input)="filterMateriels()">
      </div>

      <button class="scan-btn" (click)="startScan()">
        <ion-icon name="qr-code-outline"></ion-icon>
      </button>
    </div>

    <div class="list-container" style="padding-bottom: 100px;">

      <div *ngIf="filteredMateriels.length === 0" class="empty-state">
        <ion-icon name="hammer-outline"></ion-icon>
        <p>Aucun matériel trouvé</p>
      </div>

      <div *ngFor="let mat of filteredMateriels" 
           class="tool-card" 
           [class]="mat.etat || 'Bon'">

        <div class="card-main" (click)="openTransfer(mat)">
          
          <div class="img-wrapper">
            <img 
              *ngIf="getImageUrl(mat)" 
              [src]="getThumbUrl(getImageUrl(mat))"
              crossorigin="anonymous"
            >
            <ion-icon 
              *ngIf="!getImageUrl(mat)"
              [name]="mat.chantier_id ? 'construct' : 'cube'">
            </ion-icon>
          </div>

          <div class="text-info">
            <h3 class="tool-name">{{ mat.nom }}</h3>
            <p class="tool-ref">{{ mat.reference }}</p>
            
            <div class="location-row">
               <ion-icon [name]="mat.chantier_id ? 'location-outline' : 'home-outline'" size="small"></ion-icon>
               <span>{{ mat.chantier_id ? getChantierName(mat.chantier_id) : 'Dépôt' }}</span>
            </div>
          </div>

        </div>

        <div class="card-side-actions">
          <ion-button fill="clear" color="dark" (click)="openEdit(mat)">
            <ion-icon name="create-outline" slot="icon-only"></ion-icon>
          </ion-button>
          
          <ion-button fill="clear" color="danger" (click)="deleteMateriel(mat)">
            <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>

      </div>
    </div>
  </div>

  <div class="desktop-only">

    <div class="desktop-header">
      <h1>Parc Matériel</h1>

      <div class="actions">
        <input type="file" #csvInput (change)="onCSVSelected($event)" accept=".csv" style="display: none;" />
        <ion-button (click)="csvInput.click()">Importer CSV</ion-button>
        <ion-searchbar 
          placeholder="Rechercher..." 
          [(ngModel)]="searchTerm" 
          (ionInput)="filterMateriels()">
        </ion-searchbar>
      </div>
    </div>

    <div class="equipment-grid">

      <div 
        *ngFor="let mat of filteredMateriels" 
        class="equip-card" 
        (click)="openTransfer(mat)"
      >

       <div class="action-buttons" style="position: absolute; top: 10px; right: 10px; z-index: 10; display: flex; gap: 5px;">
           
           <div (click)="$event.stopPropagation(); openEdit(mat)" style="background: white; padding: 6px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer;">
              <ion-icon name="create-outline" color="primary"></ion-icon>
           </div>

           <div (click)="$event.stopPropagation(); deleteMateriel(mat)" style="background: white; padding: 6px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer;">
              <ion-icon name="trash-outline" color="danger"></ion-icon>
           </div>

        </div>

        <div class="status-dot" [class.active]="mat.chantier_id">
          <ion-icon [name]="mat.chantier_id ? 'construct' : 'shield-checkmark'"></ion-icon>
        </div>

        <div class="equip-image">
          <img 
            *ngIf="getImageUrl(mat)" 
            [src]="getThumbUrl(getImageUrl(mat))"
            crossorigin="anonymous"
            style="width:100%; height:100%; object-fit:contain;"
          >
          <ion-icon 
            *ngIf="!getImageUrl(mat)"
            name="hammer" 
            style="font-size:64px; color:#333; opacity:0.1;">
          </ion-icon>
        </div>

        <div class="equip-info">
          <h3>{{ mat.nom }}</h3>
          <p class="ref">{{ mat.reference }}</p>

          <div class="location-tag" [class.out]="mat.chantier_id">
            {{ mat.chantier_id ? 'Sur Chantier' : 'Au Dépôt' }}
          </div>

          <p class="chantier-name" *ngIf="mat.chantier_id">
            {{ getChantierName(mat.chantier_id) }}
          </p>
          
          <ion-badge [color]="mat.etat === 'Bon' ? 'success' : 'warning'" style="margin-top: 5px;">
            {{ mat.etat || 'Bon' }}
          </ion-badge>
        </div>

      </div>

    </div>
  </div>

  <ion-fab 
    vertical="bottom" horizontal="end" 
    slot="fixed" 
    style="margin-bottom: calc(20px + var(--ion-safe-area-bottom, 0)); margin-right: 10px;"
  >
    <ion-fab-button color="dark" (click)="addMateriel()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

</ion-content>