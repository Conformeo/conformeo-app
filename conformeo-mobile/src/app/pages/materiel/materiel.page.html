<ion-header class="ion-no-border">
  <ion-toolbar style="--background: #1e3c72; --color: white;">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home" text="" color="light"></ion-back-button>
    </ion-buttons>
    <ion-title *ngIf="!searchTerm">Matériel</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="inventory-content">

  <div class="mobile-only">

    <div class="header-section">
      <div class="header-top">
        <h1 class="page-title">Inventaire</h1>
        <p class="page-subtitle">Gérez vos équipements</p>
      </div>

      <div class="stats-row">
        <div class="stat-item">
          <span class="stat-num">{{ materiels.length }}</span>
          <span class="stat-label">Total</span>
        </div>
        <div class="stat-item warning">
          <span class="stat-num">{{ getMaterielsSortis() }}</span>
          <span class="stat-label">Sortis</span>
        </div>
        <div class="stat-item success">
          <span class="stat-num">{{ getMaterielsDepot() }}</span>
          <span class="stat-label">Dépôt</span>
        </div>
      </div>
    </div>

    <div class="search-container">
      <div class="search-wrapper">
        <ion-icon name="search-outline" class="search-icon"></ion-icon>
        <input 
          type="text" 
          placeholder="Rechercher..." 
          [(ngModel)]="searchTerm" 
          (input)="filterMateriels()">
      </div>

      <button class="scan-btn" (click)="startScan()">
        <ion-icon name="qr-code-outline"></ion-icon>
      </button>
    </div>

    <div class="list-container" style="padding-bottom: 100px;">

      <div *ngIf="filteredMateriels.length === 0" class="empty-state">
        <ion-icon name="hammer-outline" style="font-size: 48px; opacity: 0.5;"></ion-icon>
        <p>Aucun matériel trouvé</p>
        <ion-button fill="outline" size="small" (click)="addMateriel()">Ajouter un équipement</ion-button>
      </div>

      <div *ngFor="let mat of filteredMateriels" 
           class="tool-card" 
           [class]="mat.etat || 'Bon'">

        <div class="card-main" (click)="openTransfer(mat)">
          
          <div class="img-wrapper"
               [class.border-green]="mat.statut_vgp === 'CONFORME'"
               [class.border-orange]="mat.statut_vgp === 'A PREVOIR'"
               [class.border-red]="mat.statut_vgp === 'NON CONFORME'"
               [class.border-gray]="!mat.statut_vgp || mat.statut_vgp === 'INCONNU'"
               style="position: relative;">
            
            <img 
              *ngIf="getImageUrl(mat)" 
              [src]="getThumbUrl(getImageUrl(mat))"
              crossorigin="anonymous"
              onerror="this.style.display='none'"
            >
            <ion-icon 
              *ngIf="!getImageUrl(mat)"
              [name]="mat.chantier_id ? 'construct' : 'cube'"
              style="font-size: 24px; color: #666;"> 
            </ion-icon>

            <div class="vgp-badge-mobile" 
                 [class.bg-green]="mat.statut_vgp === 'CONFORME'"
                 [class.bg-orange]="mat.statut_vgp === 'A PREVOIR'"
                 [class.bg-red]="mat.statut_vgp === 'NON CONFORME'"
                 [class.bg-gray]="!mat.statut_vgp || mat.statut_vgp === 'INCONNU'"
                 style="position: absolute; bottom: 5px; right: 5px; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; color: white; font-weight: bold;">
              {{ mat.statut_vgp === 'CONFORME' ? 'VGP OK' : (mat.statut_vgp === 'A PREVOIR' ? 'VGP Bientôt' : (mat.statut_vgp === 'NON CONFORME' ? 'VGP EXPIRÉE' : 'VGP ?')) }}
            </div>
          </div>

          <div class="text-info">
            <h3 class="tool-name">{{ mat.nom }}</h3>
            <p class="tool-ref">{{ mat.reference || mat.ref_interne || 'Sans réf.' }}</p>
            
            <div class="location-row">
               <ion-icon [name]="mat.chantier_id ? 'location-outline' : 'home-outline'" size="small"></ion-icon>
               <span>{{ mat.chantier_id ? getChantierName(mat.chantier_id) : 'Dépôt' }}</span>
            </div>
          </div>

        </div>

        <div class="card-side-actions">
          <ion-button fill="clear" color="dark" (click)="openEdit(mat)">
            <ion-icon name="create-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button fill="clear" color="danger" (click)="deleteMateriel(mat)">
            <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>

      </div>
    </div>
  </div>

  <div class="desktop-only">

    <div class="desktop-header">
      <h1>Parc Matériel <ion-badge color="medium" style="vertical-align: middle; margin-left: 10px;">{{ materiels.length }}</ion-badge></h1>

      <div class="actions">
        <input type="file" #csvInput (change)="onCSVSelected($event)" accept=".csv" style="display: none;" />
        <ion-button (click)="csvInput.click()" fill="outline" color="secondary">
          <ion-icon name="cloud-upload-outline" slot="start"></ion-icon> Import CSV
        </ion-button>
        <ion-button (click)="addMateriel()">
          <ion-icon name="add" slot="start"></ion-icon> Nouveau
        </ion-button>
        
        <div class="search-box">
            <ion-icon name="search-outline"></ion-icon>
            <input type="text" placeholder="Rechercher..." [(ngModel)]="searchTerm" (input)="filterMateriels()">
        </div>
      </div>
    </div>

    <div *ngIf="filteredMateriels.length === 0" class="empty-state-desktop" style="text-align: center; margin-top: 50px; color: #666;">
        <div style="background: #f0f2f5; width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
            <ion-icon name="cube-outline" style="font-size: 48px; opacity: 0.5;"></ion-icon>
        </div>
        <h2>Votre inventaire est vide</h2>
        <p>Commencez par ajouter du matériel ou importez un fichier CSV.</p>
        <ion-button (click)="addMateriel()" style="margin-top: 20px;">Ajouter un équipement</ion-button>
    </div>

    <div class="equipment-grid">

      <div *ngFor="let mat of filteredMateriels" class="equip-card" (click)="openTransfer(mat)">

       <div class="action-buttons" style="position: absolute; top: 10px; right: 10px; z-index: 10; display: flex; gap: 5px;">
           <div (click)="$event.stopPropagation(); openEdit(mat)" class="icon-btn edit-btn">
              <ion-icon name="create-outline"></ion-icon>
           </div>
           <div (click)="$event.stopPropagation(); deleteMateriel(mat)" class="icon-btn delete-btn">
              <ion-icon name="trash-outline"></ion-icon>
           </div>
        </div>

        <div class="equip-image"
             [class.border-green]="mat.statut_vgp === 'CONFORME'"
             [class.border-orange]="mat.statut_vgp === 'A PREVOIR'"
             [class.border-red]="mat.statut_vgp === 'NON CONFORME'"
             [class.border-gray]="!mat.statut_vgp || mat.statut_vgp === 'INCONNU'">
          
          <img 
            *ngIf="getImageUrl(mat)" 
            [src]="getThumbUrl(getImageUrl(mat))"
            crossorigin="anonymous"
            onerror="this.style.display='none'"
          >
          <ion-icon 
            *ngIf="!getImageUrl(mat)"
            name="hammer-outline" 
            style="font-size:64px; color:#ccc;">
          </ion-icon>

          <div class="vgp-badge" 
               [class.bg-green]="mat.statut_vgp === 'CONFORME'"
               [class.bg-orange]="mat.statut_vgp === 'A PREVOIR'"
               [class.bg-red]="mat.statut_vgp === 'NON CONFORME'"
               [class.bg-gray]="!mat.statut_vgp || mat.statut_vgp === 'INCONNU'">
            <ion-icon name="shield-checkmark"></ion-icon>
            {{ mat.statut_vgp || 'INCONNU' }}
          </div>
        </div>

        <div class="equip-info">
          <h3>{{ mat.nom }}</h3>
          <p class="ref">{{ mat.reference || mat.ref_interne || 'Sans référence' }}</p> 
          
          <div class="bottom-info-group">
            <div class="location-tag" [class.out]="mat.chantier_id">
              {{ mat.chantier_id ? 'Sur Chantier' : 'Au Dépôt' }}
            </div>

            <p class="chantier-name">
              {{ mat.chantier_id ? getChantierName(mat.chantier_id) : '' }}
            </p>
            
            <ion-button expand="block" fill="outline" size="small" (click)="$event.stopPropagation(); showQrCode(mat)">
              <ion-icon name="qr-code-outline" slot="start"></ion-icon>
              Passeport
            </ion-button>
          </div>
        </div>

      </div>

    </div>
  </div>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed" class="mobile-only" style="margin-bottom: 20px; margin-right: 10px;">
    <ion-fab-button color="dark" (click)="addMateriel()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

</ion-content>