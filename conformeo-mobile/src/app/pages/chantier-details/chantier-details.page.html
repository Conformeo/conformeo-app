<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-buttons slot="start"><ion-back-button defaultHref="/home"></ion-back-button></ion-buttons>
    <ion-title>D√©tails Chantier</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="editChantier()">
        <ion-icon name="create-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-segment [(ngModel)]="segment" mode="md" class="header-segment">
    <ion-segment-button value="suivi"><ion-label>Suivi & Terrain</ion-label></ion-segment-button>
    <ion-segment-button value="doe"><ion-label>DOE & Fin</ion-label></ion-segment-button>
  </ion-segment>
</ion-header>

<ion-content [fullscreen]="true" class="bg-light">

  <div class="header-image-container">
    <img [src]="chantier?.cover_url || 'assets/chantier-placeholder.jpg'" class="cover-img" 
         onerror="this.src='assets/chantier-placeholder.jpg'">
    <div class="header-overlay">
      <div class="header-text">
        <h1 class="chantier-title">{{ chantier?.nom }}</h1>
        <p class="chantier-subtitle">{{ chantier?.client }}</p>
      </div>
    </div>
  </div>

  <div class="body-container">

    <div *ngIf="segment === 'suivi'" class="animate-fade">

      <ion-card class="info-card">
        <ion-card-content>
          <div class="header-row" (click)="openItinerary()">
            <ion-icon name="location" color="primary"></ion-icon>
            <h2>{{ chantier?.adresse || 'Adresse non d√©finie' }}</h2>
            <ion-icon name="navigate" color="tertiary" class="gps-icon"></ion-icon>
          </div>
          
          <div class="dates-row">
            <div>
              <span class="label">D√âBUT</span>
              <span class="value">{{ chantier?.date_debut | date:'dd/MM/yy' }}</span>
            </div>
            <div>
              <span class="label">FIN</span>
              <span class="value">{{ chantier?.date_fin | date:'dd/MM/yy' }}</span>
            </div>
            
            <div class="status-wrapper">
              <span class="label">STATUT</span>
              <ion-select interface="popover" [value]="chantier?.est_actif" (ionChange)="updateStatus($event)" class="status-select" [class.actif]="chantier?.est_actif">
                <ion-select-option [value]="true">En cours üü¢</ion-select-option>
                <ion-select-option [value]="false">Termin√© üèÅ</ion-select-option>
              </ion-select>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <div class="actions-grid">
        <div class="action-btn" (click)="downloadPdf()">
          <div class="icon-circle bg-pdf"><ion-icon name="document-text"></ion-icon></div>
          <span>PDF</span>
        </div>
        <div class="action-btn" (click)="sendJournal()">
          <div class="icon-circle bg-mail"><ion-icon name="mail"></ion-icon></div>
          <span>Envoyer</span>
        </div>
        <div class="action-btn" [routerLink]="['/pdp-form', chantierId]">
          <div class="icon-circle bg-pdp"><ion-icon name="document-lock-outline"></ion-icon></div>
          <span>PdP</span>
        </div>
        <div class="action-btn" (click)="openSignature()">
          <div class="icon-circle bg-sign"><ion-icon name="create"></ion-icon></div>
          <span>Signer</span>
        </div>
      </div>

      <div class="content-wrapper">
  
        <app-task-list 
          *ngIf="chantier" 
          [chantierId]="chantier.id || 0">
        </app-task-list>

      </div>
      
      <div class="section-header" *ngIf="materielsSurSite.length > 0">
        <h3>Mat√©riel sur place ({{ materielsSurSite.length }})</h3>
      </div>
      <div class="materiel-scroll" *ngIf="materielsSurSite.length > 0">
        <ion-card *ngFor="let mat of materielsSurSite" class="mat-card">
          <div class="mat-img" [style.backgroundImage]="'url(' + (mat.image_url || 'assets/no-img.png') + ')'"></div>
          <ion-card-header>
            <ion-card-title>{{ mat.nom }}</ion-card-title>
            <div class="etat-badge" [ngClass]="mat.etat.toLowerCase()">{{ mat.etat }}</div>
          </ion-card-header>
        </ion-card>
      </div>

      <div class="section-header"><h3>Journal Photo</h3></div>
      <div *ngIf="rapports.length === 0" class="empty-journal">
        <p>Aucune observation photo. üëá</p>
      </div>

      <ion-card *ngFor="let rap of rapports" class="rapport-card" (click)="openRapportDetails(rap)">
        <div *ngIf="hasImage(rap)" class="rapport-img" [style.backgroundImage]="'url(' + getFirstImage(rap) + ')'">
          <div class="date-badge">{{ rap.date_creation | date:'dd MMM' }}</div>
        </div>
        <ion-card-content>
          <div class="top-line">
            <h2>{{ rap.titre || 'Rapport' }}</h2>
            <ion-badge [color]="rap.niveau_urgence === 'Critique' ? 'danger' : 'success'">{{ rap.niveau_urgence }}</ion-badge>
          </div>
        </ion-card-content>
      </ion-card>

      <div style="height: 80px;"></div>
    </div>

    <div *ngIf="segment === 'doe'" class="animate-fade">
      
      <div class="doe-intro">
        <ion-icon name="archive-outline" size="large" color="primary"></ion-icon>
        <p>Dossier de fin de chantier</p>
      </div>

      <div class="section-header" *ngIf="documentsList.length > 0">
        <h3>Documents S√©curit√© & Suivi</h3>
      </div>

      <ion-list inset="true" *ngIf="documentsList.length > 0" class="security-docs-list">
        <ion-item *ngFor="let doc of documentsList" button (click)="doc.action()" detail="false">
          <div slot="start" class="doc-icon-circle" [ngClass]="'bg-' + doc.color">
            <ion-icon [name]="doc.icon" color="light"></ion-icon>
          </div>
          <ion-label>
            <h3>{{ doc.titre }}</h3>
            <p>{{ doc.date | date:'dd/MM/yyyy' }}</p>
          </ion-label>
          <ion-icon name="download-outline" slot="end" color="medium"></ion-icon>
        </ion-item>
      </ion-list>
      
      <ion-accordion-group expand="inset" class="doe-accordion">
        
        <ion-accordion value="PLANS">
          <ion-item slot="header" color="light"><ion-icon name="map-outline" slot="start" color="primary"></ion-icon><ion-label>Plans Conformes</ion-label><ion-badge slot="end">{{ getCount('PLANS') }}</ion-badge></ion-item>
          <div class="ion-padding content-box" slot="content">
            <ion-button expand="block" fill="outline" size="small" (click)="uploadDoeDoc('PLANS')">
              <ion-icon name="cloud-upload" slot="start"></ion-icon> Ajouter un plan
            </ion-button>
            <ion-list>
              <ion-item *ngFor="let d of getDocs('PLANS')">
                <ion-label class="ion-text-wrap">{{ d.titre }}</ion-label>
                <ion-icon name="trash" slot="end" color="danger" (click)="deleteDoc(d.id)"></ion-icon>
              </ion-item>
            </ion-list>
          </div>
        </ion-accordion>

        <ion-accordion value="NOTICES">
          <ion-item slot="header" color="light"><ion-icon name="book" slot="start" color="secondary"></ion-icon><ion-label>Notices Techniques</ion-label><ion-badge slot="end" color="secondary">{{ getCount('NOTICES') }}</ion-badge></ion-item>
          <div class="ion-padding content-box" slot="content">
            <ion-button expand="block" fill="outline" size="small" (click)="uploadDoeDoc('NOTICES')">Ajouter une notice</ion-button>
            <ion-list>
              <ion-item *ngFor="let d of getDocs('NOTICES')"><ion-label>{{ d.titre }}</ion-label><ion-icon name="trash" slot="end" color="danger" (click)="deleteDoc(d.id)"></ion-icon></ion-item>
            </ion-list>
          </div>
        </ion-accordion>

        <ion-accordion value="MAINTENANCE">
          <ion-item slot="header" color="light"><ion-icon name="hammer-outline" slot="start" color="warning"></ion-icon><ion-label>Maintenance</ion-label><ion-badge slot="end" color="warning">{{ getCount('MAINTENANCE') }}</ion-badge></ion-item>
          <div class="ion-padding content-box" slot="content">
            <ion-button expand="block" fill="outline" size="small" (click)="uploadDoeDoc('MAINTENANCE')">Ajouter un carnet</ion-button>
            <ion-list>
              <ion-item *ngFor="let d of getDocs('MAINTENANCE')"><ion-label>{{ d.titre }}</ion-label><ion-icon name="trash" slot="end" color="danger" (click)="deleteDoc(d.id)"></ion-icon></ion-item>
            </ion-list>
          </div>
        </ion-accordion>

        <ion-accordion value="GARANTIES">
          <ion-item slot="header" color="light"><ion-icon name="ribbon" slot="start" color="success"></ion-icon><ion-label>Garanties</ion-label><ion-badge slot="end" color="success">{{ getCount('GARANTIES') }}</ion-badge></ion-item>
          <div class="ion-padding content-box" slot="content">
            <ion-button expand="block" fill="outline" size="small" (click)="uploadDoeDoc('GARANTIES')">Ajouter certificat</ion-button>
            <ion-list>
              <ion-item *ngFor="let d of getDocs('GARANTIES')"><ion-label>{{ d.titre }}</ion-label><ion-icon name="trash" slot="end" color="danger" (click)="deleteDoc(d.id)"></ion-icon></ion-item>
            </ion-list>
          </div>
        </ion-accordion>

        <ion-accordion value="DECHETS">
          <ion-item slot="header" color="light"><ion-icon name="trash-outline" slot="start" color="medium"></ion-icon><ion-label>D√©chets & DIUO</ion-label><ion-badge slot="end" color="medium">{{ getCount('DECHETS') }}</ion-badge></ion-item>
          <div class="ion-padding content-box" slot="content">
            <ion-button expand="block" fill="outline" size="small" (click)="uploadDoeDoc('DECHETS')">Ajouter BSD</ion-button>
            <ion-list>
              <ion-item *ngFor="let d of getDocs('DECHETS')"><ion-label>{{ d.titre }}</ion-label><ion-icon name="trash" slot="end" color="danger" (click)="deleteDoc(d.id)"></ion-icon></ion-item>
            </ion-list>
          </div>
        </ion-accordion>

      </ion-accordion-group>

      <div class="ion-padding ion-margin-top">
        <ion-button expand="block" size="large" color="dark" (click)="downloadFullDoe()">
          <ion-icon name="download-outline" slot="start" class="ion-margin-end"></ion-icon> T√âL√âCHARGER LE DOE (.zip)
        </ion-button>
      </div>
    </div>

  </div>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="segment === 'suivi'">
    <ion-fab-button (click)="takePhoto()">
      <ion-icon name="camera"></ion-icon>
    </ion-fab-button>
  </ion-fab>

</ion-content>

<input #doeFileInput type="file" (change)="onDoeFileSelected($event)" hidden>